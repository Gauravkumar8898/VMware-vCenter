---
- name: get VM disk space for AWX inventory hosts
  hosts: all
  gather_facts: no

  vars:
    snapshot_name: "Snapshot for patching"
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "vDC-TBD-Site"

  tasks:

    # -----------------------------------
    # GET ONLY DISK INFORMATION
    # -----------------------------------
    - name: Get disk info for VM
      vmware_guest_disk_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        name: "{{ inventory_hostname }}"
      delegate_to: localhost
      register: disk_info

    - name: Show raw disk info (debug)
      debug:
        var: disk_info

    # -------------------------------
    # FIXED â€” NO MORE ERRORS
    # -------------------------------
    - name: Calculate total disk size in GB
      set_fact:
        total_disk_gb: >-
          {{ disk_info.guest_disk_info
            | dict2items
            | map(attribute='value.capacity_in_bytes')
            | sum
            | float / 1024 / 1024 / 1024 }}

    - name: Show total disk size
      debug:
        msg: "Total Disk Size: {{ total_disk_gb | round(2) }} GB"