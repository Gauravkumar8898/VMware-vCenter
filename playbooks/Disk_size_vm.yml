---
- name: Get VM Storage and Attached Datastore Free Space
  hosts: all
  gather_facts: no
  connection: local

  vars:
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "vDC-TBD-Site"

  tasks:
    # -------------------------------------------------------
    # 1. Get VM Facts (Storage + Datastore References)
    # -------------------------------------------------------
    - name: Get VM facts
      community.vmware.vmware_guest_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter_name }}"
        name: "{{ inventory_hostname }}"
        schema: vsphere
        properties:
          - summary.storage
          - datastore
      delegate_to: localhost
      register: vm_facts

    # -------------------------------------------------------
    # 2. Extract Datastore IDs attached to VM
    # -------------------------------------------------------
    - name: Extract VM datastore IDs
      ansible.builtin.set_fact:
        vm_datastore_ids: >-
          {{ vm_facts.instance.datastore
             | map('regex_replace', '^vim.Datastore:', '')
             | list }}

    # -------------------------------------------------------
    # 3. Get ALL Datastore Information
    # -------------------------------------------------------
    - name: Get datastore information
      community.vmware.vmware_datastore_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter_name }}"
      delegate_to: localhost
      register: datastore_facts

    # -------------------------------------------------------
    # 4. Display VM Storage Usage
    # -------------------------------------------------------
    - name: Display VM Storage
      ansible.builtin.debug:
        msg:
          - "---------------------------------------------"
          - "VM Name               : {{ inventory_hostname }}"
          - "VM Storage Used (GB)  : {{ (vm_facts.instance.summary.storage.committed | float / 1024 / 1024 / 1024) | round(2) }}"
          - "---------------------------------------------"

    # -------------------------------------------------------
    # 5. Display ONLY Attached Datastore Free Space
    # -------------------------------------------------------
    - name: Display attached datastore free space
      ansible.builtin.debug:
        msg:
          - "Datastore Name        : {{ item.name }}"
          - "Datastore Capacity   : {{ (item.capacity | float / 1024 / 1024 / 1024) | round(2) }} GB"
          - "Datastore Free Space : {{ (item.freeSpace | float / 1024 / 1024 / 1024) | round(2) }} GB"
          - "---------------------------------------------"
      loop: "{{ datastore_facts.datastores }}"
      when: (item.datastore | default(item.id)) in vm_datastore_ids
      loop_control:
        label: "{{ item.name }}"
