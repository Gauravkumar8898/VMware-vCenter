---
- name: Production VM Snapshot (Safety Checks:- Power & Space)
  hosts: all
  gather_facts: no
  connection: local

  # Fail fast if vCenter credentials are missing
  vars:
    snapshot_name: "Snapshot for patching"
    snapshot_desc: "Created by Ansible via AWX for Patching Maintenance"

    # Credentials (Best Practice: Inject these via AWX Credentials)
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "{{ lookup('env', 'VCENTER_DATACENTER') }}"
    vm_folder: "{{ lookup('env', 'VCENTER_VM_FOLDER') }}"

  tasks:
    # -------------------------------------------------------------------------
    # STEP 1: GATHER VM FACTS
    # -------------------------------------------------------------------------
    - name: "1. Fetch VM Facts (Storage & Power)"
      community.vmware.vmware_guest_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter_name }}"
        name: "{{ inventory_hostname }}"
        schema: "vsphere"
        properties:
          - summary.storage
          - summary.runtime
          - datastore
      delegate_to: localhost
      register: vm_facts

    # -------------------------------------------------------------------------
    # STEP 2: GATHER DATASTORE FACTS
    # -------------------------------------------------------------------------
    - name: "2. Fetch Datastore Capacity Details"
      community.vmware.vmware_datastore_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "{{ datacenter_name }}"
        name: "{{ item.name }}"
      delegate_to: localhost
      loop: "{{ vm_facts.instance.datastore }}"
      register: datastore_facts
      when: vm_facts.instance.datastore is defined

    # -------------------------------------------------------------------------
    # STEP 3: CALCULATE LOGIC (THE DECISION ENGINE)
    # -------------------------------------------------------------------------
    - name: "3. Evaluate Safety Conditions"
      ansible.builtin.set_fact:
        # Math: Sum of Free Space on all attached Datastores
        total_ds_free_bytes: "{{ datastore_facts.results | map(attribute='datastores.0.freeSpace') | map('int') | sum }}"
        # Math: Total Space the VM is currently using (Committed)
        vm_committed_bytes: "{{ vm_facts.instance.summary.storage.committed | int }}"
        # Boolean: Is VM Powered On?
        is_powered_on: "{{ vm_facts.instance.summary.runtime.powerState == 'poweredOn' }}"
      when: datastore_facts.results is defined

    - name: "4. Define Pass/Fail Flags"
      ansible.builtin.set_fact:
        # Logic: Free Space MUST be greater than Committed Space
        check_space: "{{ total_ds_free_bytes | int > vm_committed_bytes | int }}"
        check_power: "{{ is_powered_on }}"

    # -------------------------------------------------------------------------
    # STEP 4: REPORTING (LOGGING)
    # -------------------------------------------------------------------------
    - name: "5. Pre-Flight Check Summary"
      ansible.builtin.debug:
        msg:
          - "======================================================="
          - " HOST: {{ inventory_hostname }}"
          - "-------------------------------------------------------"
          - " 1. POWER CHECK : {{ 'PASS' if check_power else 'FAIL (VM is OFF)' }}"
          - "    - State     : {{ vm_facts.instance.summary.runtime.powerState }}"
          - "-------------------------------------------------------"
          - " 2. SPACE CHECK : {{ 'PASS' if check_space else 'FAIL (Low Space)' }}"
          - "    - Committed : {{ (vm_committed_bytes | float / 1073741824) | round(2) }} GB"
          - "    - Free      : {{ (total_ds_free_bytes | float / 1073741824) | round(2) }} GB"
          - "-------------------------------------------------------"
          - " ACTION         : {{ 'TAKING SNAPSHOT' if (check_power and check_space) else 'SKIPPING' }}"
          - "======================================================="

    # -------------------------------------------------------------------------
    # STEP 5: EXECUTION (CONDITIONAL SNAPSHOT)
    # -------------------------------------------------------------------------
    - name: "6. Create Snapshot (Skipped if checks fail)"
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        validate_certs: no
        name: "{{ inventory_hostname }}"
        state: present
        snapshot_name: "{{ snapshot_name }}"
        description: "{{ snapshot_desc }}"
        quiesce: no
        memory_dump: no
      delegate_to: localhost
      register: snapshot_result
      # This is the Safety Guard:
      when:
        - check_power | bool
        - check_space | bool

    - name: "7. Success Confirmation"
      ansible.builtin.debug:
        msg: "Snapshot created successfully for {{ inventory_hostname }}"
      when: snapshot_result is changed