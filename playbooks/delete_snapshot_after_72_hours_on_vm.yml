---
- name: Delete VMware snapshots older than 72 hours
  hosts: all
  gather_facts: no
  connection: local

  vars:
    # Snapshot Config
    snapshot_name: "Snapshot for patching"
    max_age_hours: 72

    # vCenter Config
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "{{ lookup('env', 'VCENTER_DATACENTER') }}"
    vm_folder: "{{ lookup('env', 'VCENTER_VM_FOLDER') }}"   # REQUIRED for snapshot modules

  tasks:

    # -------------------------------------------------------
    # 1. Get Snapshot Information
    # -------------------------------------------------------
    - name: Gather snapshot facts for the VM
      community.vmware.vmware_guest_snapshot_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ inventory_hostname }}"
        folder: "{{ vm_folder }}"
        validate_certs: no
      delegate_to: localhost
      register: snapshot_info

    - name: Debug snapshot info
      debug:
        var: snapshot_info

    # -------------------------------------------------------
    # 2. Find snapshots older than X hours
    # -------------------------------------------------------
    - name: Filter snapshots older than {{ max_age_hours }} hours
      set_fact:
        old_snapshots: >-
          {{
            snapshot_info.snapshots
            | json_query("[?create_time < `" + ((ansible_date_time.epoch | int) - (max_age_hours * 3600)) | to_datetime | to_iso8601 + "`]")
          }}
      when: snapshot_info.snapshots is defined

    - name: Show old snapshots
      debug:
        var: old_snapshots
      when: old_snapshots is defined

    # -------------------------------------------------------
    # 3. Delete old snapshots
    # -------------------------------------------------------
    - name: Delete each old snapshot
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        state: absent
        snapshot_id: "{{ item.id }}"
        validate_certs: no
      loop: "{{ old_snapshots }}"
      when: old_snapshots | length > 0
      delegate_to: localhost
      register: delete_results

    # -------------------------------------------------------
    # 4. Show result
    # -------------------------------------------------------
    - name: Show deletion results
      debug:
        var: delete_results
      when: delete_results is defined
