---
- name: Delete VMware snapshots older than 72 hours
  hosts: all
  gather_facts: no
  connection: local

  vars:
    snapshot_name: "Snapshot for patching"
    max_age_hours: 72

    # vCenter config
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "vDC-TBD-Site"
    vm_folder: "/{{ datacenter_name }}/vm"

  tasks:

    # -------------------------------------------------------
    # 1. Get snapshot info
    # -------------------------------------------------------
    - name: Gather snapshot facts for the VM
      community.vmware.vmware_guest_snapshot_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        validate_certs: no
      delegate_to: localhost
      register: snapshot_facts

    - name: Debug snapshot structure
      ansible.builtin.debug:
        var: snapshot_facts.guest_snapshots

    # -------------------------------------------------------
    # 2. Extract list safely
    # -------------------------------------------------------
    - name: Set snapshot list
      set_fact:
        vm_snapshots: "{{ snapshot_facts.guest_snapshots.snapshots | default([]) }}"

    # -------------------------------------------------------
    # 3. Filter snapshots older than X hours
    # -------------------------------------------------------
    - name: Find snapshots older than {{ max_age_hours }} hours
      set_fact:
        old_snapshots: >-
          {{
            vm_snapshots
            | selectattr('name', 'equalto', snapshot_name)
            | selectattr(
                'creation_time',
                'match',
                '.*'
              )
            | select(
                'selectattr',
                'creation_time',
                'defined'
              )
            | select(
                'selectattr',
                'creation_time',
                'truthy'
              )
            | select(
                'extract',
                'creation_time'
              )
          }}
      when: vm_snapshots | length > 0

    - name: Determine snapshots older than threshold
      set_fact:
        snapshots_to_delete: >-
          {{
            vm_snapshots
            | selectattr('name', 'equalto', snapshot_name)
            | selectattr(
                'creation_time',
                'search',
                '.+'
              )
            | selectattr(
                'creation_time',
                'map',
                'to_datetime',
                '%Y-%m-%dT%H:%M:%S.%f%z'
              )
            | selectattr(
                'creation_time',
                'select',
                'lt',
                (now(tz="UTC") | to_datetime) - max_age_hours*3600
              )
          }}

    - name: Debug snapshots to delete
      debug:
        var: snapshots_to_delete

    # -------------------------------------------------------
    # 4. Delete snapshots
    # -------------------------------------------------------
    - name: Delete snapshots older than {{ max_age_hours }} hours
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        state: absent
        snapshot_name: "{{ item.name }}"
        validate_certs: no
      delegate_to: localhost
      loop: "{{ snapshots_to_delete }}"
      when: snapshots_to_delete | length > 0
      register: delete_result

    - name: Show deletion results
      debug:
        var: delete_result
      when: delete_result is defined
