---
- name: Delete VMware snapshots older than 72 hours
  hosts: all
  gather_facts: no
  connection: local

  vars:
    # Snapshot Configuration
    snapshot_name: "Snapshot for patching"
    max_age_hours: 72

    # vCenter Configuration
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"

    # Path Configuration
    datacenter_name: "vDC-TBD-Site"
    # The 'folder' parameter is mandatory for finding VMs by name in these modules
    vm_folder: "/{{ datacenter_name }}/vm"

  tasks:
    # -------------------------------------------------------
    # 1. Get Snapshot Information
    # -------------------------------------------------------
    - name: Gather snapshot facts for the VM
      community.vmware.vmware_guest_snapshot_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        validate_certs: no
      delegate_to: localhost
      register: snapshot_facts

    - name: Debug Snapshot Data Structure
      ansible.builtin.debug:
        var: snapshot_facts.guest_snapshots
        # FIX: Indented verbosity to be a module parameter, not a task keyword
        verbosity: 1

    # -------------------------------------------------------
    # 2. Analyze and Delete Old Snapshots
    # -------------------------------------------------------
    - name: Delete snapshot if it exists and is older than {{ max_age_hours }} hours
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        validate_certs: no
        name: "{{ inventory_hostname }}"
        state: absent
        snapshot_name: "{{ item.name }}"
      delegate_to: localhost
      # FIX: Handle both Dictionary and List return types safely
      # If it's a dict (mapping), we iterate over values(). If list, iterate directly.
      loop: >-
        {{ 
          snapshot_facts.guest_snapshots.values() | list 
          if snapshot_facts.guest_snapshots is mapping 
          else snapshot_facts.guest_snapshots | default([]) 
        }}
      when:
        # Safety check: Ensure item has 'name' before comparing
        - item.name is defined
        - item.name == snapshot_name
        # Age check
        - >-
          ((now(utc=True) - (item.creation_time | to_datetime('%Y-%m-%dT%H:%M:%S.%fZ'))).total_seconds()) > (max_age_hours * 3600)
      loop_control:
        label: "{{ item.name | default('Unknown') }}"
      register: delete_result

    - name: Show deletion results
      ansible.builtin.debug:
        msg: "Snapshot '{{ item.item.name }}' deleted: {{ item.changed }}"
      loop: "{{ delete_result.results }}"
      when: item.skipped is not defined or not item.skipped