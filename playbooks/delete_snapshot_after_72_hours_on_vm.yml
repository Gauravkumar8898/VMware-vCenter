- name: Delete VMware snapshots older than 72 hours
  hosts: all
  gather_facts: no
  connection: local

  vars:
    snapshot_name: "Snapshot for patching"
    max_age_hours: 72
    # We remove the %z here because we are going to strip the timezone manually
    # to avoid the "offset-naive" error.
    date_fmt: "%Y-%m-%dT%H:%M:%S.%f"

    # vCenter config
    vcenter_hostname: "{{ lookup('env', 'VCENTER_HOSTNAME') }}"
    vcenter_username: "{{ lookup('env', 'VCENTER_USERNAME') }}"
    vcenter_password: "{{ lookup('env', 'VCENTER_PASSWORD') }}"
    datacenter_name: "vDC-TBD-Site"
    vm_folder: "/{{ datacenter_name }}/vm"

  tasks:
    # -------------------------------------------------------
    # 1. Get snapshot info
    # -------------------------------------------------------
    - name: Gather snapshot facts for the VM
      community.vmware.vmware_guest_snapshot_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        validate_certs: no
      delegate_to: localhost
      register: snapshot_facts

    - name: Set snapshot list safely
      set_fact:
        vm_snapshots: "{{ snapshot_facts.guest_snapshots.snapshots | default([]) }}"

    # -------------------------------------------------------
    # 2. Filter snapshots (Fixed for Timezone Error)
    # -------------------------------------------------------
    - name: Initialize empty deletion list
      set_fact:
        snapshots_to_delete: []

    - name: Populate list of snapshots older than {{ max_age_hours }} hours
      set_fact:
        snapshots_to_delete: "{{ snapshots_to_delete + [item] }}"
      loop: "{{ vm_snapshots }}"
      when:
        # 1. Check if name matches
        - item.name == snapshot_name
        # 2. Logic:
        #    a. item.creation_time.split('+')[0] -> takes "2025-11-28T03:32:45.512889" (removes +00:00)
        #    b. to_datetime(date_fmt) -> Converts to Naive Datetime
        #    c. now(utc=true).replace(tzinfo=None) -> Gets current UTC time as Naive Datetime
        - >-
          (
            (now(utc=true).replace(tzinfo=None)) - 
            (item.creation_time.split('+')[0] | to_datetime(date_fmt))
          ).total_seconds() > (max_age_hours | int * 3600)

    - name: Debug snapshots identified for deletion
      debug:
        msg: "Will delete: {{ item.name }} (Created: {{ item.creation_time }})"
      loop: "{{ snapshots_to_delete }}"

    # -------------------------------------------------------
    # 3. Delete snapshots
    # -------------------------------------------------------
    - name: Delete snapshots older than {{ max_age_hours }} hours
      community.vmware.vmware_guest_snapshot:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        datacenter: "{{ datacenter_name }}"
        folder: "{{ vm_folder }}"
        name: "{{ inventory_hostname }}"
        state: absent
        snapshot_name: "{{ item.name }}"
        validate_certs: no
      delegate_to: localhost
      loop: "{{ snapshots_to_delete }}"
      register: delete_result
      # Safety check: ensure list exists
      when: snapshots_to_delete | length > 0

    - name: Show deletion results
      debug:
        var: delete_result
      when: delete_result is defined